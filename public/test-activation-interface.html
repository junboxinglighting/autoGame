<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¿€æ´»ç éªŒè¯æ¥å£æµ‹è¯•å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .test-section {
            margin-bottom: 40px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .section-header {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .section-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
        }
        
        .status-pending {
            background: #ffeaa7;
            color: #d63031;
        }
        
        .status-testing {
            background: #74b9ff;
            color: white;
        }
        
        .status-success {
            background: #00b894;
            color: white;
        }
        
        .status-error {
            background: #e17055;
            color: white;
        }
        
        .section-content {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #d68910;
        }
        
        .result-panel {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }
        
        .result-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .result-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .result-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #3498db;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .stat-label {
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .quick-fill {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .quick-fill-btn {
            padding: 5px 10px;
            background: #ecf0f1;
            border: 1px solid #bdc3c7;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .quick-fill-btn:hover {
            background: #d5dbdb;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” æ¿€æ´»ç éªŒè¯æ¥å£æµ‹è¯•å·¥å…·</h1>
            <p>å…¨é¢æµ‹è¯•æ¿€æ´»ç éªŒè¯æ¥å£çš„å„ç§åŠŸèƒ½å’Œåœºæ™¯</p>
        </div>
        
        <div class="content">
            <!-- ç»Ÿè®¡é¢æ¿ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="totalTests">0</div>
                    <div class="stat-label">æ€»æµ‹è¯•æ¬¡æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="successTests">0</div>
                    <div class="stat-label">æˆåŠŸæ¬¡æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="failedTests">0</div>
                    <div class="stat-label">å¤±è´¥æ¬¡æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="ipConflicts">0</div>
                    <div class="stat-label">IPå†²çªæ¬¡æ•°</div>
                </div>
            </div>
            
            <!-- æµ‹è¯•åœºæ™¯1ï¼šå‚æ•°éªŒè¯æµ‹è¯• -->
            <div class="test-section">
                <div class="section-header">
                    <div class="section-title">ğŸ“‹ å‚æ•°éªŒè¯æµ‹è¯•</div>
                    <div class="status-badge status-pending" id="status-param">å¾…æµ‹è¯•</div>
                </div>
                <div class="section-content">
                    <p>æµ‹è¯•æ¥å£å¯¹ä¸åŒå‚æ•°ç»„åˆçš„éªŒè¯é€»è¾‘</p>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-primary" onclick="testMissingParams()">æµ‹è¯•ç¼ºå°‘å‚æ•°</button>
                        <button class="btn btn-primary" onclick="testInvalidFormat()">æµ‹è¯•æ— æ•ˆæ ¼å¼</button>
                        <button class="btn btn-primary" onclick="testWrongMethod()">æµ‹è¯•é”™è¯¯æ–¹æ³•</button>
                    </div>
                    <div class="result-panel" id="result-param"></div>
                </div>
            </div>
            
            <!-- æµ‹è¯•åœºæ™¯2ï¼šæ­£å¸¸æ¿€æ´»æµç¨‹æµ‹è¯• -->
            <div class="test-section">
                <div class="section-header">
                    <div class="section-title">âœ… æ­£å¸¸æ¿€æ´»æµç¨‹æµ‹è¯•</div>
                    <div class="status-badge status-pending" id="status-activate">å¾…æµ‹è¯•</div>
                </div>
                <div class="section-content">
                    <div class="quick-fill">
                        <button class="quick-fill-btn" onclick="fillTestData1()">å¡«å…¥æµ‹è¯•æ•°æ®1</button>
                        <button class="quick-fill-btn" onclick="fillTestData2()">å¡«å…¥æµ‹è¯•æ•°æ®2</button>
                        <button class="quick-fill-btn" onclick="clearForm()">æ¸…ç©ºè¡¨å•</button>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="activateCode">æ¿€æ´»ç  *</label>
                            <input type="text" id="activateCode" placeholder="32ä½å­—æ¯æ•°å­—ç»„åˆ">
                        </div>
                        <div class="form-group">
                            <label for="activateUserId">ç”¨æˆ·ID *</label>
                            <input type="number" id="activateUserId" value="1" placeholder="ç”¨æˆ·ID">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="activateDeviceFingerprint">è®¾å¤‡æŒ‡çº¹ *</label>
                            <input type="text" id="activateDeviceFingerprint" value="test-device-001" placeholder="è®¾å¤‡æŒ‡çº¹">
                        </div>
                        <div class="form-group">
                            <label for="activateIp">IPåœ°å€ *</label>
                            <input type="text" id="activateIp" value="192.168.1.100" placeholder="IPåœ°å€">
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button class="btn btn-success" onclick="testNormalActivation()">ğŸš€ æµ‹è¯•é¦–æ¬¡æ¿€æ´»</button>
                        <button class="btn btn-primary" onclick="getAvailableCodes()">ğŸ“ è·å–å¯ç”¨æ¿€æ´»ç </button>
                    </div>
                    <div class="result-panel" id="result-activate"></div>
                </div>
            </div>
            
            <!-- æµ‹è¯•åœºæ™¯3ï¼šIPéªŒè¯æµ‹è¯• -->
            <div class="test-section">
                <div class="section-header">
                    <div class="section-title">ğŸŒ IPåœ°å€éªŒè¯æµ‹è¯•</div>
                    <div class="status-badge status-pending" id="status-ip">å¾…æµ‹è¯•</div>
                </div>
                <div class="section-content">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ipTestCode">å·²æ¿€æ´»çš„æ¿€æ´»ç </label>
                            <input type="text" id="ipTestCode" placeholder="è¾“å…¥å·²æ¿€æ´»çš„æ¿€æ´»ç ">
                        </div>
                        <div class="form-group">
                            <label for="ipTestScenario">æµ‹è¯•åœºæ™¯</label>
                            <select id="ipTestScenario">
                                <option value="same">ç›¸åŒIPéªŒè¯</option>
                                <option value="different">ä¸åŒIPéªŒè¯</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="ipTestIp">æµ‹è¯•IPåœ°å€</label>
                            <input type="text" id="ipTestIp" value="192.168.1.200" placeholder="æµ‹è¯•ç”¨çš„IPåœ°å€">
                        </div>
                        <div class="form-group">
                            <label for="ipTestDevice">è®¾å¤‡æŒ‡çº¹</label>
                            <input type="text" id="ipTestDevice" value="test-device-002" placeholder="è®¾å¤‡æŒ‡çº¹">
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px;">
                        <button class="btn btn-warning" onclick="testIpValidation()">ğŸ” æµ‹è¯•IPéªŒè¯</button>
                        <button class="btn btn-primary" onclick="testSameIp()">âœ… æµ‹è¯•ç›¸åŒIP</button>
                        <button class="btn btn-primary" onclick="testDifferentIp()">âŒ æµ‹è¯•ä¸åŒIP</button>
                    </div>
                    <div class="result-panel" id="result-ip"></div>
                </div>
            </div>
            
            <!-- æµ‹è¯•åœºæ™¯4ï¼šç»¼åˆæµ‹è¯• -->
            <div class="test-section">
                <div class="section-header">
                    <div class="section-title">ğŸ”¬ ç»¼åˆåŠŸèƒ½æµ‹è¯•</div>
                    <div class="status-badge status-pending" id="status-comprehensive">å¾…æµ‹è¯•</div>
                </div>
                <div class="section-content">
                    <p>ä¸€é”®è¿è¡Œæ‰€æœ‰æµ‹è¯•åœºæ™¯ï¼Œå…¨é¢éªŒè¯æ¥å£åŠŸèƒ½</p>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-success" onclick="runAllTests()" id="runAllBtn">ğŸ¯ è¿è¡Œå…¨éƒ¨æµ‹è¯•</button>
                        <button class="btn btn-warning" onclick="runSpecificTests()">ğŸ”§ è¿è¡ŒæŒ‡å®šæµ‹è¯•</button>
                        <button class="btn btn-primary" onclick="exportResults()">ğŸ“Š å¯¼å‡ºæµ‹è¯•æŠ¥å‘Š</button>
                    </div>
                    <div class="result-panel" id="result-comprehensive"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æµ‹è¯•ç»Ÿè®¡
        let testStats = {
            total: 0,
            success: 0,
            failed: 0,
            ipConflicts: 0
        };
        
        // æµ‹è¯•ç»“æœå­˜å‚¨
        let testResults = [];
        
        // APIåŸºç¡€URL
        const API_BASE = window.location.origin;
        
        // æ›´æ–°ç»Ÿè®¡æ˜¾ç¤º
        function updateStats() {
            document.getElementById('totalTests').textContent = testStats.total;
            document.getElementById('successTests').textContent = testStats.success;
            document.getElementById('failedTests').textContent = testStats.failed;
            document.getElementById('ipConflicts').textContent = testStats.ipConflicts;
        }
        
        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `result-panel result-${type}`;
            element.textContent = content;
            element.style.display = 'block';
        }
        
        // æ›´æ–°çŠ¶æ€
        function updateStatus(sectionId, status) {
            const element = document.getElementById(`status-${sectionId}`);
            element.className = `status-badge status-${status}`;
            const statusText = {
                'pending': 'å¾…æµ‹è¯•',
                'testing': 'æµ‹è¯•ä¸­',
                'success': 'æˆåŠŸ',
                'error': 'å¤±è´¥'
            };
            element.textContent = statusText[status] || status;
        }
        
        // è®°å½•æµ‹è¯•ç»“æœ
        function recordResult(testName, success, statusCode, message, data = null) {
            testStats.total++;
            if (success) {
                testStats.success++;
                if (statusCode === 1) {
                    // æ¿€æ´»æˆåŠŸ
                } else if (statusCode === 3) {
                    testStats.ipConflicts++;
                }
            } else {
                testStats.failed++;
            }
            
            testResults.push({
                timestamp: new Date().toLocaleString(),
                testName,
                success,
                statusCode,
                message,
                data
            });
            
            updateStats();
        }
        
        // å¿«é€Ÿå¡«å……æµ‹è¯•æ•°æ®
        function fillTestData1() {
            document.getElementById('activateCode').value = 'BEW6EDQCYDRBZNBQ4DJIJGTQYGA4993A';
            document.getElementById('activateUserId').value = '1';
            document.getElementById('activateDeviceFingerprint').value = 'test-device-001';
            document.getElementById('activateIp').value = '192.168.1.100';
        }
        
        function fillTestData2() {
            document.getElementById('activateCode').value = 'YSXK5SPD9UPPAFUTNPAQHVDC8AZ9T773';
            document.getElementById('activateUserId').value = '1';
            document.getElementById('activateDeviceFingerprint').value = 'test-device-002';
            document.getElementById('activateIp').value = '192.168.1.101';
        }
        
        function clearForm() {
            document.getElementById('activateCode').value = '';
            document.getElementById('activateUserId').value = '1';
            document.getElementById('activateDeviceFingerprint').value = 'test-device-001';
            document.getElementById('activateIp').value = '192.168.1.100';
        }
        
        // è·å–å¯ç”¨æ¿€æ´»ç 
        async function getAvailableCodes() {
            updateStatus('activate', 'testing');
            showResult('result-activate', 'æ­£åœ¨è·å–å¯ç”¨æ¿€æ´»ç ...', 'info');
            
            try {
                // è¿™é‡Œæ¨¡æ‹Ÿè·å–æ¿€æ´»ç çš„è¿‡ç¨‹
                const codes = [
                    'BEW6EDQCYDRBZNBQ4DJIJGTQYGA4993A',
                    'YSXK5SPD9UPPAFUTNPAQHVDC8AZ9T773',
                    'U7JBENYSCCWTCARQCQSNGFYKJTAZN8T7',
                    'JTAKNHHXSD3XRRYQUMYGD8AHFEIDC754',
                    'DW2RSCC9AWRZCLQ7HWMPKXVTRHW37394'
                ];
                
                const result = `å¯ç”¨æ¿€æ´»ç åˆ—è¡¨ï¼š\n${codes.map((code, index) => `${index + 1}. ${code}`).join('\n')}\n\nç‚¹å‡»ä»»æ„æ¿€æ´»ç å¯è‡ªåŠ¨å¡«å…¥è¡¨å•`;
                showResult('result-activate', result, 'success');
                updateStatus('activate', 'success');
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                setTimeout(() => {
                    document.getElementById('activateCode').value = codes[0];
                }, 100);
                
            } catch (error) {
                showResult('result-activate', `è·å–æ¿€æ´»ç å¤±è´¥: ${error.message}`, 'error');
                updateStatus('activate', 'error');
            }
        }
        
        // æµ‹è¯•ç¼ºå°‘å‚æ•°
        async function testMissingParams() {
            updateStatus('param', 'testing');
            showResult('result-param', 'æ­£åœ¨æµ‹è¯•ç¼ºå°‘å‚æ•°çš„æƒ…å†µ...', 'info');
            
            const testCases = [
                { data: {}, desc: 'æ‰€æœ‰å‚æ•°ç¼ºå¤±' },
                { data: { code: 'TEST123' }, desc: 'ç¼ºå°‘userIdã€deviceFingerprintã€ip' },
                { data: { code: 'TEST123', userId: 1 }, desc: 'ç¼ºå°‘deviceFingerprintã€ip' },
                { data: { code: 'TEST123', userId: 1, deviceFingerprint: 'device1' }, desc: 'ç¼ºå°‘ip' },
            ];
            
            let results = 'å‚æ•°éªŒè¯æµ‹è¯•ç»“æœï¼š\n\n';
            
            for (const testCase of testCases) {
                try {
                    const response = await fetch(`${API_BASE}/api/codes/validate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(testCase.data)
                    });
                    
                    const result = await response.json();
                    results += `âœ… ${testCase.desc}: ${response.status} - ${result.message || result.statusMessage}\n`;
                    
                    recordResult(`å‚æ•°éªŒè¯-${testCase.desc}`, response.status === 400, response.status, result.message);
                    
                } catch (error) {
                    results += `âŒ ${testCase.desc}: è¯·æ±‚å¤±è´¥ - ${error.message}\n`;
                    recordResult(`å‚æ•°éªŒè¯-${testCase.desc}`, false, 0, error.message);
                }
            }
            
            showResult('result-param', results, 'info');
            updateStatus('param', 'success');
        }
        
        // æµ‹è¯•æ— æ•ˆæ ¼å¼
        async function testInvalidFormat() {
            const testCases = [
                { code: '123', desc: 'æ¿€æ´»ç è¿‡çŸ­' },
                { code: 'INVALID_CODE_TOO_LONG_XXXXXXXXXXXXX', desc: 'æ¿€æ´»ç è¿‡é•¿' },
                { code: 'INVALID-CODE-WITH-SPECIAL-CHARS!@#', desc: 'åŒ…å«ç‰¹æ®Šå­—ç¬¦' },
            ];
            
            let results = 'æ ¼å¼éªŒè¯æµ‹è¯•ç»“æœï¼š\n\n';
            
            for (const testCase of testCases) {
                try {
                    const response = await fetch(`${API_BASE}/api/codes/validate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            code: testCase.code,
                            userId: 1,
                            deviceFingerprint: 'test-device',
                            ip: '192.168.1.1'
                        })
                    });
                    
                    const result = await response.json();
                    results += `âœ… ${testCase.desc}: ${response.status} - ${result.message || result.statusMessage}\n`;
                    
                } catch (error) {
                    results += `âŒ ${testCase.desc}: è¯·æ±‚å¤±è´¥ - ${error.message}\n`;
                }
            }
            
            showResult('result-param', results, 'info');
        }
        
        // æµ‹è¯•é”™è¯¯çš„HTTPæ–¹æ³•
        async function testWrongMethod() {
            try {
                const response = await fetch(`${API_BASE}/api/codes/validate`, {
                    method: 'GET'  // é”™è¯¯çš„æ–¹æ³•ï¼Œåº”è¯¥æ˜¯POST
                });
                
                const result = await response.json();
                const resultText = `HTTPæ–¹æ³•æµ‹è¯•ç»“æœï¼š\nçŠ¶æ€ç : ${response.status}\næ¶ˆæ¯: ${result.message || result.statusMessage}`;
                showResult('result-param', resultText, response.status === 405 ? 'success' : 'error');
                
            } catch (error) {
                showResult('result-param', `HTTPæ–¹æ³•æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // æµ‹è¯•æ­£å¸¸æ¿€æ´»
        async function testNormalActivation() {
            const code = document.getElementById('activateCode').value;
            const userId = parseInt(document.getElementById('activateUserId').value);
            const deviceFingerprint = document.getElementById('activateDeviceFingerprint').value;
            const ip = document.getElementById('activateIp').value;
            
            if (!code || !userId || !deviceFingerprint || !ip) {
                showResult('result-activate', 'è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ', 'error');
                return;
            }
            
            updateStatus('activate', 'testing');
            showResult('result-activate', 'æ­£åœ¨æµ‹è¯•æ¿€æ´»ç éªŒè¯...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/codes/validate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, userId, deviceFingerprint, ip })
                });
                
                const result = await response.json();
                
                let resultText = `æ¿€æ´»æµ‹è¯•ç»“æœï¼š\n`;
                resultText += `çŠ¶æ€ç : ${response.status}\n`;
                resultText += `æˆåŠŸ: ${result.success}\n`;
                resultText += `æ¶ˆæ¯: ${result.message}\n`;
                
                if (result.data) {
                    resultText += `\nè¯¦ç»†ä¿¡æ¯ï¼š\n`;
                    resultText += `éªŒè¯æœ‰æ•ˆ: ${result.data.valid}\n`;
                    resultText += `ä¸šåŠ¡çŠ¶æ€ç : ${result.data.statusCode}\n`;
                    resultText += `è¯¦ç»†æ¶ˆæ¯: ${result.data.message}\n`;
                    
                    if (result.data.token) {
                        resultText += `Token: ${result.data.token.substring(0, 50)}...\n`;
                    }
                    
                    if (result.data.expiryTime) {
                        resultText += `è¿‡æœŸæ—¶é—´: ${new Date(result.data.expiryTime).toLocaleString()}\n`;
                    }
                }
                
                const isSuccess = result.success && result.data?.statusCode === 1;
                showResult('result-activate', resultText, isSuccess ? 'success' : 'error');
                updateStatus('activate', isSuccess ? 'success' : 'error');
                
                recordResult('æ­£å¸¸æ¿€æ´»', result.success, result.data?.statusCode, result.data?.message, result.data);
                
                // å¦‚æœæ¿€æ´»æˆåŠŸï¼Œå°†æ¿€æ´»ç å¡«å…¥IPæµ‹è¯•è¡¨å•
                if (isSuccess) {
                    document.getElementById('ipTestCode').value = code;
                }
                
            } catch (error) {
                showResult('result-activate', `æ¿€æ´»æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                updateStatus('activate', 'error');
                recordResult('æ­£å¸¸æ¿€æ´»', false, 0, error.message);
            }
        }
        
        // æµ‹è¯•ç›¸åŒIP
        async function testSameIp() {
            const code = document.getElementById('ipTestCode').value || document.getElementById('activateCode').value;
            if (!code) {
                showResult('result-ip', 'è¯·å…ˆè¾“å…¥å·²æ¿€æ´»çš„æ¿€æ´»ç ', 'error');
                return;
            }
            
            updateStatus('ip', 'testing');
            showResult('result-ip', 'æ­£åœ¨æµ‹è¯•ç›¸åŒIPéªŒè¯...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/codes/validate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code: code,
                        userId: 1,
                        deviceFingerprint: 'test-device-same',
                        ip: '192.168.1.100'  // ä½¿ç”¨ç›¸åŒçš„IP
                    })
                });
                
                const result = await response.json();
                
                let resultText = `ç›¸åŒIPæµ‹è¯•ç»“æœï¼š\n`;
                resultText += `çŠ¶æ€ç : ${response.status}\n`;
                resultText += `æˆåŠŸ: ${result.success}\n`;
                resultText += `ä¸šåŠ¡çŠ¶æ€ç : ${result.data?.statusCode}\n`;
                resultText += `æ¶ˆæ¯: ${result.data?.message}\n`;
                
                const isSuccess = result.success && result.data?.statusCode === 1;
                showResult('result-ip', resultText, isSuccess ? 'success' : 'info');
                updateStatus('ip', isSuccess ? 'success' : 'error');
                
                recordResult('ç›¸åŒIPéªŒè¯', result.success, result.data?.statusCode, result.data?.message);
                
            } catch (error) {
                showResult('result-ip', `ç›¸åŒIPæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                updateStatus('ip', 'error');
            }
        }
        
        // æµ‹è¯•ä¸åŒIP
        async function testDifferentIp() {
            const code = document.getElementById('ipTestCode').value || document.getElementById('activateCode').value;
            if (!code) {
                showResult('result-ip', 'è¯·å…ˆè¾“å…¥å·²æ¿€æ´»çš„æ¿€æ´»ç ', 'error');
                return;
            }
            
            updateStatus('ip', 'testing');
            showResult('result-ip', 'æ­£åœ¨æµ‹è¯•ä¸åŒIPéªŒè¯...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/api/codes/validate`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        code: code,
                        userId: 2,
                        deviceFingerprint: 'test-device-different',
                        ip: '192.168.1.200'  // ä½¿ç”¨ä¸åŒçš„IP
                    })
                });
                
                const result = await response.json();
                
                let resultText = `ä¸åŒIPæµ‹è¯•ç»“æœï¼š\n`;
                resultText += `çŠ¶æ€ç : ${response.status}\n`;
                resultText += `æˆåŠŸ: ${result.success}\n`;
                resultText += `ä¸šåŠ¡çŠ¶æ€ç : ${result.data?.statusCode}\n`;
                resultText += `æ¶ˆæ¯: ${result.data?.message}\n`;
                
                if (result.data?.statusCode === 3) {
                    resultText += `\nâœ… IPå†²çªæ£€æµ‹æ­£å¸¸å·¥ä½œï¼`;
                }
                
                const isExpected = result.data?.statusCode === 3;  // æœŸæœ›è¿”å›çŠ¶æ€ç 3
                showResult('result-ip', resultText, isExpected ? 'success' : 'error');
                updateStatus('ip', isExpected ? 'success' : 'error');
                
                recordResult('ä¸åŒIPéªŒè¯', !result.success, result.data?.statusCode, result.data?.message);
                
            } catch (error) {
                showResult('result-ip', `ä¸åŒIPæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                updateStatus('ip', 'error');
            }
        }
        
        // æµ‹è¯•IPéªŒè¯
        async function testIpValidation() {
            await testSameIp();
            setTimeout(async () => {
                await testDifferentIp();
            }, 1000);
        }
        
        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        async function runAllTests() {
            const btn = document.getElementById('runAllBtn');
            btn.disabled = true;
            btn.textContent = 'ğŸ”„ æµ‹è¯•è¿›è¡Œä¸­...';
            
            updateStatus('comprehensive', 'testing');
            showResult('result-comprehensive', 'å¼€å§‹è¿è¡Œå…¨é¢æµ‹è¯•...\n\n', 'info');
            
            try {
                // é‡ç½®ç»Ÿè®¡
                testStats = { total: 0, success: 0, failed: 0, ipConflicts: 0 };
                testResults = [];
                updateStats();
                
                // 1. å‚æ•°éªŒè¯æµ‹è¯•
                showResult('result-comprehensive', '1. æ­£åœ¨è¿›è¡Œå‚æ•°éªŒè¯æµ‹è¯•...\n', 'info');
                await testMissingParams();
                await new Promise(r => setTimeout(r, 500));
                
                // 2. æ ¼å¼éªŒè¯æµ‹è¯•
                showResult('result-comprehensive', '1. å‚æ•°éªŒè¯æµ‹è¯•å®Œæˆ\n2. æ­£åœ¨è¿›è¡Œæ ¼å¼éªŒè¯æµ‹è¯•...\n', 'info');
                await testInvalidFormat();
                await new Promise(r => setTimeout(r, 500));
                
                // 3. HTTPæ–¹æ³•æµ‹è¯•
                showResult('result-comprehensive', '1. å‚æ•°éªŒè¯æµ‹è¯•å®Œæˆ\n2. æ ¼å¼éªŒè¯æµ‹è¯•å®Œæˆ\n3. æ­£åœ¨è¿›è¡ŒHTTPæ–¹æ³•æµ‹è¯•...\n', 'info');
                await testWrongMethod();
                await new Promise(r => setTimeout(r, 500));
                
                // 4. æ­£å¸¸æ¿€æ´»æµ‹è¯•
                showResult('result-comprehensive', '1. å‚æ•°éªŒè¯æµ‹è¯•å®Œæˆ\n2. æ ¼å¼éªŒè¯æµ‹è¯•å®Œæˆ\n3. HTTPæ–¹æ³•æµ‹è¯•å®Œæˆ\n4. æ­£åœ¨è¿›è¡Œæ­£å¸¸æ¿€æ´»æµ‹è¯•...\n', 'info');
                fillTestData1();  // è‡ªåŠ¨å¡«å……æµ‹è¯•æ•°æ®
                await testNormalActivation();
                await new Promise(r => setTimeout(r, 1000));
                
                // 5. IPéªŒè¯æµ‹è¯•
                showResult('result-comprehensive', '1. å‚æ•°éªŒè¯æµ‹è¯•å®Œæˆ\n2. æ ¼å¼éªŒè¯æµ‹è¯•å®Œæˆ\n3. HTTPæ–¹æ³•æµ‹è¯•å®Œæˆ\n4. æ­£å¸¸æ¿€æ´»æµ‹è¯•å®Œæˆ\n5. æ­£åœ¨è¿›è¡ŒIPéªŒè¯æµ‹è¯•...\n', 'info');
                await testIpValidation();
                await new Promise(r => setTimeout(r, 1000));
                
                // ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
                const report = generateTestReport();
                showResult('result-comprehensive', report, 'success');
                updateStatus('comprehensive', 'success');
                
            } catch (error) {
                showResult('result-comprehensive', `å…¨é¢æµ‹è¯•è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯: ${error.message}`, 'error');
                updateStatus('comprehensive', 'error');
            }
            
            btn.disabled = false;
            btn.textContent = 'ğŸ¯ è¿è¡Œå…¨éƒ¨æµ‹è¯•';
        }
        
        // ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
        function generateTestReport() {
            let report = 'ğŸ“Š æµ‹è¯•æŠ¥å‘Š\n';
            report += '=' * 50 + '\n\n';
            report += `æµ‹è¯•æ—¶é—´: ${new Date().toLocaleString()}\n`;
            report += `æ€»æµ‹è¯•æ•°: ${testStats.total}\n`;
            report += `æˆåŠŸæ•°: ${testStats.success}\n`;
            report += `å¤±è´¥æ•°: ${testStats.failed}\n`;
            report += `IPå†²çªæ•°: ${testStats.ipConflicts}\n`;
            report += `æˆåŠŸç‡: ${testStats.total > 0 ? ((testStats.success / testStats.total) * 100).toFixed(2) : 0}%\n\n`;
            
            report += 'è¯¦ç»†æµ‹è¯•ç»“æœ:\n';
            report += '-' * 30 + '\n';
            
            testResults.forEach((result, index) => {
                report += `${index + 1}. ${result.testName}\n`;
                report += `   æ—¶é—´: ${result.timestamp}\n`;
                report += `   ç»“æœ: ${result.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±è´¥'}\n`;
                report += `   çŠ¶æ€ç : ${result.statusCode}\n`;
                report += `   æ¶ˆæ¯: ${result.message}\n\n`;
            });
            
            return report;
        }
        
        // å¯¼å‡ºæµ‹è¯•æŠ¥å‘Š
        function exportResults() {
            const report = generateTestReport();
            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `activation-test-report-${new Date().getTime()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateStats();
            console.log('æ¿€æ´»ç éªŒè¯æ¥å£æµ‹è¯•å·¥å…·å·²åŠ è½½');
        });
    </script>
</body>
</html>
