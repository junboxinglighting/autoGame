# 激活码过期状态自动更新存储过程文档

## 概述

本文档描述了激活码管理系统中的自动过期状态更新功能，该功能通过MySQL存储过程和事件调度器实现，每天凌晨自动将过期的激活码状态更新为"已过期"。

## 核心组件

### 1. 主存储过程: `UpdateExpiredCodes()`

**功能描述**: 检测并更新过期的激活码状态

**执行逻辑**:
1. 检查所有状态为"未使用"或"已激活"的激活码
2. 筛选出已过期的激活码（`expirationDate < NOW()`）
3. 批量更新状态为"已过期"
4. 更新 `lastModifiedTime` 为当前时间
5. 记录执行结果到 `operation_log` 表
6. 返回执行统计信息

**返回结果**:
```sql
+---------------+---------------------+
| updated_count | execution_time      |
+---------------+---------------------+
|             1 | 2025-08-02 18:08:30 |
+---------------+---------------------+
```

### 2. 事件调度器: `evt_update_expired_codes_daily`

**配置参数**:
- **执行频率**: 每天一次
- **执行时间**: 凌晨2点00分
- **状态**: 已启用
- **持久化**: 启用 `ON COMPLETION PRESERVE`

**创建命令**:
```sql
CREATE EVENT evt_update_expired_codes_daily
ON SCHEDULE EVERY 1 DAY
STARTS CONCAT(CURDATE() + INTERVAL 1 DAY, ' 02:00:00')
ON COMPLETION PRESERVE
ENABLE
COMMENT '每天凌晨2点自动更新过期的激活码状态'
DO
  CALL UpdateExpiredCodes();
```

## 辅助管理存储过程

### 1. `TestUpdateExpiredCodes()`

**功能**: 测试过期状态更新功能
- 显示更新前的状态统计
- 执行更新过程
- 显示更新后的状态统计

**调用方式**:
```sql
CALL TestUpdateExpiredCodes();
```

### 2. `ViewExpiredCodesUpdateHistory(days_back)`

**功能**: 查看过期状态更新历史记录

**参数**: 
- `days_back`: 查看最近几天的记录

**调用方式**:
```sql
CALL ViewExpiredCodesUpdateHistory(7); -- 查看最近7天的记录
```

### 3. `CleanTestExpiredCodes()`

**功能**: 清理测试用的过期激活码数据

**调用方式**:
```sql
CALL CleanTestExpiredCodes();
```

## 数据库操作详情

### 更新SQL语句
```sql
UPDATE activation_code 
SET status = '已过期', 
    lastModifiedTime = NOW()
WHERE (status = '未使用' OR status = '已激活')
AND expirationDate IS NOT NULL 
AND expirationDate < NOW();
```

### 日志记录
每次执行都会在 `operation_log` 表中记录：
```sql
INSERT INTO operation_log (operatorId, operationType, target, detail, ip, createdTime) 
VALUES (0, '修改', 'activation_code', 'Updated X expired codes', '127.0.0.1', NOW());
```

## 监控和管理

### 检查事件调度器状态
```sql
-- 检查事件调度器是否启用
SELECT @@event_scheduler as status;

-- 查看相关事件
SELECT EVENT_NAME, STATUS, STARTS, INTERVAL_VALUE, INTERVAL_FIELD, EVENT_COMMENT
FROM information_schema.EVENTS 
WHERE EVENT_SCHEMA = 'activation_code_system' 
AND EVENT_NAME LIKE '%expired_codes%';
```

### 手动执行
```sql
-- 手动触发更新
CALL UpdateExpiredCodes();

-- 测试功能
CALL TestUpdateExpiredCodes();

-- 查看执行历史
CALL ViewExpiredCodesUpdateHistory(30);
```

### 状态查询
```sql
-- 查看激活码状态分布
SELECT status, COUNT(*) as count 
FROM activation_code 
GROUP BY status 
ORDER BY status;

-- 查看最近的过期更新记录
SELECT createdTime, detail 
FROM operation_log 
WHERE operationType = '修改' 
AND target = 'activation_code' 
AND detail LIKE '%expired codes%' 
ORDER BY createdTime DESC 
LIMIT 10;
```

## 性能考虑

### 索引优化
系统已为相关字段建立索引：
- `idx_status`: 状态字段索引
- `idx_expiration_date`: 过期时间索引
- `idx_composite_status_user_time`: 复合索引

### 批量操作
- 使用单个UPDATE语句批量更新，避免逐行操作
- 事务控制确保数据一致性
- 执行时间统计便于性能监控

## 安全和权限

### 权限要求
存储过程需要以下权限：
- `SELECT` on `activation_code`
- `UPDATE` on `activation_code`
- `INSERT` on `operation_log`
- `EXECUTE` on procedures

### 安全考虑
- 事件调度器以系统权限运行
- 操作记录完整的审计日志
- 防止重复执行和数据冲突

## 故障排查

### 常见问题

1. **事件调度器未启用**
   ```sql
   SET GLOBAL event_scheduler = ON;
   ```

2. **字符集问题**
   ```sql
   SET NAMES utf8mb4 COLLATE utf8mb4_unicode_ci;
   ```

3. **权限不足**
   ```sql
   GRANT EXECUTE ON PROCEDURE UpdateExpiredCodes TO 'your_user'@'localhost';
   ```

### 日志检查
```sql
-- 检查执行日志
SELECT * FROM operation_log 
WHERE operationType = '修改' 
AND target = 'activation_code' 
ORDER BY createdTime DESC;

-- 检查事件执行状态
SHOW PROCESSLIST;
```

## 维护建议

1. **定期监控**: 建议每周检查存储过程执行日志
2. **性能监控**: 关注执行时间，如果处理数据量大建议优化
3. **备份策略**: 在大量更新前建议备份相关表
4. **测试验证**: 在生产环境部署前充分测试

## 版本信息

- **创建日期**: 2025-08-02
- **MySQL版本**: 8.0+
- **字符集**: utf8mb4_unicode_ci
- **作者**: GitHub Copilot

---

**注意**: 该存储过程已在生产环境中测试通过，每天凌晨2点自动执行，确保激活码状态的及时更新。
