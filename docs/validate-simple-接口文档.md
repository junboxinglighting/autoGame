# æ¿€æ´»ç éªŒè¯æ¥å£æ–‡æ¡£ (Validate-Simple)

## æ¥å£æ¦‚è¿°

**æ¥å£åç§°**: æ¿€æ´»ç éªŒè¯æ¥å£ï¼ˆç®€åŒ–ç‰ˆï¼‰  
**æ¥å£è·¯å¾„**: `/api/codes/validate-simple`  
**è¯·æ±‚æ–¹æ³•**: `POST`  
**Content-Type**: `application/json`  
**åŠŸèƒ½æè¿°**: éªŒè¯æ¿€æ´»ç æœ‰æ•ˆæ€§å¹¶å®ç°è®¾å¤‡æŒ‡çº¹ç»‘å®šéªŒè¯æœºåˆ¶

## æ ¸å¿ƒåŠŸèƒ½

### è®¾å¤‡æŒ‡çº¹éªŒè¯é€»è¾‘
1. **é¦–æ¬¡æ¿€æ´»**: æ¿€æ´»ç çŠ¶æ€ä¸º"æœªä½¿ç”¨"æ—¶ï¼Œç»‘å®šè®¾å¤‡æŒ‡çº¹å¹¶æ›´æ–°çŠ¶æ€ä¸º"å·²æ¿€æ´»"
2. **é‡å¤éªŒè¯**: æ¿€æ´»ç çŠ¶æ€ä¸º"å·²æ¿€æ´»"æ—¶ï¼ŒéªŒè¯è¯·æ±‚è®¾å¤‡æŒ‡çº¹æ˜¯å¦ä¸ç»‘å®šè®¾å¤‡æŒ‡çº¹ä¸€è‡´
3. **è®¾å¤‡å†²çªæ£€æµ‹**: å¦‚æœè®¾å¤‡æŒ‡çº¹ä¸ä¸€è‡´ï¼Œè¿”å›çŠ¶æ€ç 3è¡¨ç¤ºè®¾å¤‡å†²çª

## è¯·æ±‚å‚æ•°

### è¯·æ±‚ä½“ç»“æ„
```json
{
  "code": "string",           // æ¿€æ´»ç ï¼ˆå¿…å¡«ï¼‰
  "userId": "number",         // ç”¨æˆ·IDï¼ˆå¿…å¡«ï¼‰
  "deviceFingerprint": "string", // è®¾å¤‡æŒ‡çº¹ï¼ˆå¿…å¡«ï¼‰
  "ip": "string"             // IPåœ°å€ï¼ˆå¿…å¡«ï¼‰
}
```

### å‚æ•°è¯¦ç»†è¯´æ˜

| å‚æ•°å | ç±»å‹ | å¿…å¡« | é•¿åº¦é™åˆ¶ | è¯´æ˜ |
|--------|------|------|----------|------|
| code | string | âœ… | 32ä½ | æ¿€æ´»ç ï¼Œå¿…é¡»ä¸º32ä½å¤§å†™å­—æ¯å’Œæ•°å­—ç»„åˆ |
| userId | number | âœ… | - | ç”¨æˆ·IDï¼Œå¿…é¡»ä¸ºæ­£æ•´æ•°ä¸”åœ¨userè¡¨ä¸­å­˜åœ¨ |
| deviceFingerprint | string | âœ… | 1-255 | è®¾å¤‡æŒ‡çº¹æ ‡è¯† |
| ip | string | âœ… | 1-45 | IPåœ°å€ï¼Œæ”¯æŒIPv4å’ŒIPv6æ ¼å¼ |

### å‚æ•°éªŒè¯è§„åˆ™
- **code**: å¿…é¡»åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼ `^[A-Z0-9]{32}$`
- **userId**: å¿…é¡»ä¸ºå­˜åœ¨çš„ç”¨æˆ·IDï¼ˆå¤–é”®çº¦æŸï¼‰
- **deviceFingerprint**: éç©ºå­—ç¬¦ä¸²
- **ip**: æœ‰æ•ˆçš„IPåœ°å€æ ¼å¼

## å“åº”æ ¼å¼

### æˆåŠŸå“åº”ç»“æ„
```json
{
  "success": true,
  "data": {
    "valid": true,
    "message": "string",
    "statusCode": "number"
  },
  "message": "string"
}
```

### é”™è¯¯å“åº”ç»“æ„
```json
{
  "success": false,
  "data": {
    "valid": false,
    "message": "string",
    "statusCode": "number"
  },
  "message": "string"
}
```

## çŠ¶æ€ç è¯´æ˜

| statusCode | å«ä¹‰ | åœºæ™¯ |
|------------|------|------|
| 1 | éªŒè¯æˆåŠŸ | é¦–æ¬¡æ¿€æ´»æˆåŠŸ æˆ– è®¾å¤‡æŒ‡çº¹éªŒè¯é€šè¿‡ |
| 2 | éªŒè¯å¤±è´¥ | æ¿€æ´»ç ä¸å­˜åœ¨ã€å·²è¿‡æœŸã€çŠ¶æ€æ— æ•ˆ |
| 3 | è®¾å¤‡å†²çª | æ¿€æ´»ç å·²è¢«å…¶ä»–è®¾å¤‡ä½¿ç”¨ |

## å“åº”ç¤ºä¾‹

### 1. é¦–æ¬¡æ¿€æ´»æˆåŠŸ
**è¯·æ±‚**:
```json
{
  "code": "ABCD1234EFGH5678IJKL9012MNOP3456",
  "userId": 2,
  "deviceFingerprint": "device-001",
  "ip": "192.168.1.100"
}
```

**å“åº”**: `200 OK`
```json
{
  "success": true,
  "data": {
    "valid": true,
    "message": "æ¿€æ´»æˆåŠŸ",
    "statusCode": 1
  },
  "message": "éªŒè¯æˆåŠŸ"
}
```

### 2. ç›¸åŒè®¾å¤‡é‡å¤éªŒè¯
**è¯·æ±‚**:
```json
{
  "code": "ABCD1234EFGH5678IJKL9012MNOP3456",
  "userId": 2,
  "deviceFingerprint": "device-001",
  "ip": "192.168.1.100"
}
```

**å“åº”**: `200 OK`
```json
{
  "success": true,
  "data": {
    "valid": true,
    "message": "éªŒè¯é€šè¿‡",
    "statusCode": 1
  },
  "message": "éªŒè¯æˆåŠŸ"
}
```

### 3. è®¾å¤‡å†²çªæ£€æµ‹
**è¯·æ±‚**:
```json
{
  "code": "ABCD1234EFGH5678IJKL9012MNOP3456",
  "userId": 2,
  "deviceFingerprint": "device-different",
  "ip": "192.168.1.200"
}
```

**å“åº”**: `200 OK`
```json
{
  "success": false,
  "data": {
    "valid": false,
    "message": "è¯¥æ¿€æ´»ç å·²è¢«å…¶ä»–è®¾å¤‡ä½¿ç”¨",
    "statusCode": 3
  },
  "message": "è®¾å¤‡æŒ‡çº¹å†²çª"
}
```

### 4. æ¿€æ´»ç ä¸å­˜åœ¨
**è¯·æ±‚**:
```json
{
  "code": "INVALID000000000000000000000000000",
  "userId": 2,
  "deviceFingerprint": "device-001",
  "ip": "192.168.1.100"
}
```

**å“åº”**: `200 OK`
```json
{
  "success": false,
  "data": {
    "valid": false,
    "message": "æ¿€æ´»ç ä¸å­˜åœ¨",
    "statusCode": 2
  },
  "message": "æ¿€æ´»ç éªŒè¯å¤±è´¥"
}
```

### 5. æ¿€æ´»ç å·²è¿‡æœŸ
**è¯·æ±‚**:
```json
{
  "code": "EXPIRED1234567890123456789012345",
  "userId": 2,
  "deviceFingerprint": "device-001",
  "ip": "192.168.1.100"
}
```

**å“åº”**: `200 OK`
```json
{
  "success": false,
  "data": {
    "valid": false,
    "message": "æ¿€æ´»ç å·²è¿‡æœŸ",
    "statusCode": 2
  },
  "message": "æ¿€æ´»ç éªŒè¯å¤±è´¥"
}
```

## é”™è¯¯å“åº”

### å‚æ•°éªŒè¯é”™è¯¯
**å“åº”**: `400 Bad Request`
```json
{
  "error": true,
  "statusCode": 400,
  "statusMessage": "å‚æ•°ä¸å®Œæ•´",
  "message": "å‚æ•°ä¸å®Œæ•´"
}
```

### æ¿€æ´»ç æ ¼å¼é”™è¯¯
**å“åº”**: `400 Bad Request`
```json
{
  "error": true,
  "statusCode": 400,
  "statusMessage": "æ¿€æ´»ç æ ¼å¼æ— æ•ˆ",
  "message": "æ¿€æ´»ç æ ¼å¼æ— æ•ˆ"
}
```

### æ–¹æ³•ä¸å…è®¸
**å“åº”**: `405 Method Not Allowed`
```json
{
  "error": true,
  "statusCode": 405,
  "statusMessage": "æ–¹æ³•ä¸å…è®¸",
  "message": "æ–¹æ³•ä¸å…è®¸"
}
```

### æœåŠ¡å™¨å†…éƒ¨é”™è¯¯
**å“åº”**: `500 Internal Server Error`
```json
{
  "error": true,
  "statusCode": 500,
  "statusMessage": "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯: è¯¦ç»†é”™è¯¯ä¿¡æ¯",
  "message": "æœåŠ¡å™¨å†…éƒ¨é”™è¯¯: è¯¦ç»†é”™è¯¯ä¿¡æ¯"
}
```

## æ•°æ®åº“æ“ä½œ

### é¦–æ¬¡æ¿€æ´»æ—¶çš„æ•°æ®åº“æ›´æ–°
```sql
UPDATE activation_code 
SET status = 'å·²æ¿€æ´»', 
    deviceFingerprint = ?, 
    userId = ?, 
    activationDate = NOW() 
WHERE activationCode = ?
```

### è§¦å‘å™¨è‡ªåŠ¨æ“ä½œ
æ¿€æ´»ç çŠ¶æ€æ›´æ–°ä¸º"å·²æ¿€æ´»"æ—¶ï¼Œä¼šè‡ªåŠ¨è§¦å‘ `tr_activation_code_activated` è§¦å‘å™¨ï¼Œåœ¨ `activation_record` è¡¨ä¸­æ’å…¥æ¿€æ´»è®°å½•ã€‚

### è¿‡æœŸçŠ¶æ€è‡ªåŠ¨æ›´æ–°
ç³»ç»Ÿé…ç½®äº†æ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ‰§è¡Œçš„äº‹ä»¶è°ƒåº¦å™¨ `evt_update_expired_codes_daily`ï¼Œè°ƒç”¨ `UpdateExpiredCodes()` å­˜å‚¨è¿‡ç¨‹è‡ªåŠ¨å°†è¿‡æœŸçš„æ¿€æ´»ç çŠ¶æ€æ›´æ–°ä¸º"å·²è¿‡æœŸ"ã€‚

**å­˜å‚¨è¿‡ç¨‹åŠŸèƒ½**:
- è‡ªåŠ¨æ£€æµ‹è¿‡æœŸçš„æ¿€æ´»ç ï¼ˆçŠ¶æ€ä¸º"æœªä½¿ç”¨"æˆ–"å·²æ¿€æ´»"ä¸”è¿‡æœŸæ—¶é—´å°äºå½“å‰æ—¶é—´ï¼‰
- æ‰¹é‡æ›´æ–°çŠ¶æ€ä¸º"å·²è¿‡æœŸ"
- è®°å½•æ‰§è¡Œæ—¥å¿—åˆ° `operation_log` è¡¨
- æ”¯æŒæ‰‹åŠ¨è°ƒç”¨: `CALL UpdateExpiredCodes();`

## è°ƒç”¨ç¤ºä¾‹

### ç½‘é¡µé“¾æ¥å½¢å¼ (GETè¯·æ±‚)
**æ¥å£åœ°å€**: `/api/codes/validate-url`  
**è¯·æ±‚æ–¹æ³•**: `GET` æˆ– `POST`

**URLæ ¼å¼**:
```
http://localhost:3000/api/codes/validate-url?code={æ¿€æ´»ç }&userId={ç”¨æˆ·ID}&deviceFingerprint={è®¾å¤‡æŒ‡çº¹}&ip={IPåœ°å€}
```

**å®Œæ•´ç¤ºä¾‹URL**:
```
http://localhost:3000/api/codes/validate-url?code=ABCD1234EFGH5678IJKL9012MNOP3456&userId=2&deviceFingerprint=device-001&ip=192.168.1.100
```

**æµè§ˆå™¨ç›´æ¥è®¿é—®**:
- å¯ä»¥ç›´æ¥åœ¨æµè§ˆå™¨åœ°å€æ è¾“å…¥ä¸Šè¿°URL
- æ”¯æŒä¹¦ç­¾ä¿å­˜å’Œåˆ†äº«
- è¿”å›JSONæ ¼å¼å“åº”

### JavaScript (Node.js)
```javascript
const response = await fetch('http://localhost:3000/api/codes/validate-simple', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    code: 'ABCD1234EFGH5678IJKL9012MNOP3456',
    userId: 2,
    deviceFingerprint: 'device-001',
    ip: '192.168.1.100'
  })
})

const result = await response.json()
console.log('éªŒè¯ç»“æœ:', result.data.statusCode)
```

### Python
```python
import requests
import json

url = 'http://localhost:3000/api/codes/validate-simple'
data = {
    'code': 'ABCD1234EFGH5678IJKL9012MNOP3456',
    'userId': 2,
    'deviceFingerprint': 'device-001',
    'ip': '192.168.1.100'
}

response = requests.post(url, json=data)
result = response.json()
print(f"éªŒè¯ç»“æœ: {result['data']['statusCode']}")
```

### cURL
**POSTè¯·æ±‚**:
```bash
curl -X POST http://localhost:3000/api/codes/validate-simple \
  -H "Content-Type: application/json" \
  -d '{
    "code": "ABCD1234EFGH5678IJKL9012MNOP3456",
    "userId": 2,
    "deviceFingerprint": "device-001",
    "ip": "192.168.1.100"
  }'
```

**GETè¯·æ±‚ï¼ˆURLå½¢å¼ï¼‰**:
```bash
curl "http://localhost:3000/api/codes/validate-url?code=ABCD1234EFGH5678IJKL9012MNOP3456&userId=2&deviceFingerprint=device-001&ip=192.168.1.100"
```

## æ¥å£å˜ä½“

### æ ‡å‡†POSTæ¥å£
- **è·¯å¾„**: `/api/codes/validate-simple`
- **æ–¹æ³•**: `POST`
- **å‚æ•°**: JSONè¯·æ±‚ä½“
- **ç”¨é€”**: æ ‡å‡†APIè°ƒç”¨

### URLå‚æ•°æ¥å£  
- **è·¯å¾„**: `/api/codes/validate-url`
- **æ–¹æ³•**: `GET` æˆ– `POST`
- **å‚æ•°**: URLæŸ¥è¯¢å‚æ•°æˆ–JSONè¯·æ±‚ä½“
- **ç”¨é€”**: æµè§ˆå™¨ç›´æ¥è®¿é—®ã€ä¹¦ç­¾ä¿å­˜ã€é“¾æ¥åˆ†äº«

## æ³¨æ„äº‹é¡¹

### è¯·æ±‚æ–¹å¼é€‰æ‹©å»ºè®®

#### ğŸ”’ **ç”Ÿäº§ç¯å¢ƒæ¨èï¼šPOSTè¯·æ±‚**
- **å®‰å…¨æ€§é«˜**ï¼šæ¿€æ´»ç ç­‰æ•æ„Ÿå‚æ•°ä¸ä¼šå‡ºç°åœ¨URLã€æµè§ˆå™¨å†å²è®°å½•æˆ–æœåŠ¡å™¨æ—¥å¿—ä¸­
- **ç¬¦åˆRESTfulè§„èŒƒ**ï¼šæ¿€æ´»æ“ä½œæ¶‰åŠæ•°æ®çŠ¶æ€ä¿®æ”¹ï¼Œè¯­ä¹‰ä¸Šæ›´é€‚åˆä½¿ç”¨POST
- **é˜²æ­¢æ„å¤–ç¼“å­˜**ï¼šé¿å…æ¿€æ´»ç è¢«æµè§ˆå™¨æˆ–CDNç¼“å­˜
- **æ•°æ®å®Œæ•´æ€§**ï¼šæ”¯æŒæ›´å¤æ‚çš„è¯·æ±‚ä½“ç»“æ„å’ŒéªŒè¯

#### ğŸŒ **å¼€å‘/æµ‹è¯•ç¯å¢ƒï¼šGETè¯·æ±‚ä½œä¸ºè¾…åŠ©**
- **æµ‹è¯•ä¾¿åˆ©**ï¼šå¯ç›´æ¥åœ¨æµè§ˆå™¨åœ°å€æ æµ‹è¯•ï¼Œæ— éœ€é¢å¤–å·¥å…·
- **è°ƒè¯•å‹å¥½**ï¼šæ”¯æŒä¹¦ç­¾ä¿å­˜ï¼Œä¾¿äºé‡å¤æµ‹è¯•
- **æ¼”ç¤ºæ–¹ä¾¿**ï¼šå¯é€šè¿‡é“¾æ¥ç›´æ¥å±•ç¤ºåŠŸèƒ½ç»™å…¶ä»–äºº

#### âš–ï¸ **é€‰æ‹©å»ºè®®**
```
ç”Ÿäº§ç¯å¢ƒï¼šPOST (/api/codes/validate-simple) â† æ¨è
æµ‹è¯•ç¯å¢ƒï¼šGET  (/api/codes/validate-url)    â† è¾…åŠ©
```

### å®‰å…¨è€ƒè™‘
1. **è®¾å¤‡ç»‘å®š**: ä¸€æ—¦æ¿€æ´»ç è¢«æ¿€æ´»ï¼Œå°†æ°¸ä¹…ç»‘å®šåˆ°é¦–æ¬¡æ¿€æ´»çš„è®¾å¤‡æŒ‡çº¹
2. **ç”¨æˆ·éªŒè¯**: userIdå¿…é¡»ä¸ºæ•°æ®åº“ä¸­å­˜åœ¨çš„æœ‰æ•ˆç”¨æˆ·ID
3. **è®¾å¤‡å”¯ä¸€æ€§**: è®¾å¤‡æŒ‡çº¹ä½œä¸ºä¸»è¦éªŒè¯ä¾æ®ï¼Œç¡®ä¿æ¿€æ´»ç ä¸è®¾å¤‡çš„å”¯ä¸€ç»‘å®šå…³ç³»
4. **URLå®‰å…¨æ€§**: GETè¯·æ±‚å‚æ•°ä¼šå‡ºç°åœ¨æµè§ˆå™¨å†å²è®°å½•å’ŒæœåŠ¡å™¨æ—¥å¿—ä¸­ï¼Œç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨POSTè¯·æ±‚
5. **å‚æ•°åŠ å¯†**: æ•æ„Ÿå‚æ•°å»ºè®®åœ¨ä¼ è¾“å‰è¿›è¡ŒåŠ å¯†å¤„ç†

### æ€§èƒ½ä¼˜åŒ–
1. **æ•°æ®åº“ç´¢å¼•**: æ¿€æ´»ç ã€è®¾å¤‡æŒ‡çº¹ã€ç”¨æˆ·IDç­‰å­—æ®µå·²å»ºç«‹ç´¢å¼•
2. **è¿æ¥æ± **: ä½¿ç”¨MySQLè¿æ¥æ± ç®¡ç†æ•°æ®åº“è¿æ¥
3. **é”™è¯¯å¤„ç†**: å®Œå–„çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

### å…¼å®¹æ€§
- **Nuxt 3.18.0+**: åŸºäºNuxt 3æ¡†æ¶å¼€å‘
- **MySQL 8.0+**: éœ€è¦MySQL 8.0æˆ–æ›´é«˜ç‰ˆæœ¬
- **Node.js 18+**: éœ€è¦Node.js 18æˆ–æ›´é«˜ç‰ˆæœ¬

## æµ‹è¯•å»ºè®®

### åŠŸèƒ½æµ‹è¯•åœºæ™¯
1. âœ… é¦–æ¬¡æ¿€æ´»æµ‹è¯•
2. âœ… ç›¸åŒè®¾å¤‡é‡å¤éªŒè¯æµ‹è¯•  
3. âœ… ä¸åŒè®¾å¤‡å†²çªæ£€æµ‹æµ‹è¯•
4. âœ… æ¿€æ´»ç ä¸å­˜åœ¨æµ‹è¯•
5. âœ… æ¿€æ´»ç å·²è¿‡æœŸæµ‹è¯•
6. âœ… å‚æ•°éªŒè¯æµ‹è¯•
7. âœ… æ ¼å¼éªŒè¯æµ‹è¯•
8. âœ… é”™è¯¯å¤„ç†æµ‹è¯•

### å‹åŠ›æµ‹è¯•
å»ºè®®è¿›è¡Œå¹¶å‘è®¿é—®æµ‹è¯•ï¼ŒéªŒè¯æ•°æ®åº“è¿æ¥æ± å’Œäº‹åŠ¡å¤„ç†çš„ç¨³å®šæ€§ã€‚

## æ›´æ–°è®°å½•

| ç‰ˆæœ¬ | æ—¥æœŸ | æ›´æ–°å†…å®¹ |
|------|------|----------|
| 1.0.0 | 2025-08-02 | åˆå§‹ç‰ˆæœ¬ï¼Œå®ç°IPéªŒè¯åŠŸèƒ½ |
| 1.1.0 | 2025-08-02 | ä¿®æ”¹ä¸ºè®¾å¤‡æŒ‡çº¹éªŒè¯åŠŸèƒ½ |
| 1.2.0 | 2025-08-02 | æ–°å¢URLå‚æ•°è®¿é—®æ–¹å¼ï¼Œæ”¯æŒæµè§ˆå™¨ç›´æ¥è®¿é—® |
| 1.3.0 | 2025-08-02 | æ–°å¢è‡ªåŠ¨è¿‡æœŸçŠ¶æ€æ›´æ–°å­˜å‚¨è¿‡ç¨‹ï¼Œæ¯å¤©å‡Œæ™¨2ç‚¹è‡ªåŠ¨æ‰§è¡Œ |

---

**æ–‡æ¡£ç»´æŠ¤**: GitHub Copilot  
**æœ€åæ›´æ–°**: 2025å¹´8æœˆ2æ—¥
