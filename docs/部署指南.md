# 激活码验证系统部署指南

## 概述

本文档详细说明如何将激活码验证系统部署到生产服务器，包括环境配置、数据库部署、应用部署和监控配置。

## 系统要求

### 服务器配置建议

| 配置项 | 最低要求 | 推荐配置 |
|--------|----------|----------|
| CPU | 2核 | 4核+ |
| 内存 | 4GB | 8GB+ |
| 硬盘 | 20GB | 50GB+ SSD |
| 操作系统 | Ubuntu 20.04+ / CentOS 8+ | Ubuntu 22.04 LTS |
| 网络 | 5Mbps | 100Mbps+ |

### 软件环境要求

- **Node.js**: 18.0.0+
- **MySQL**: 8.0.0+
- **Nginx**: 1.18.0+
- **PM2**: 5.0.0+（进程管理）
- **SSL证书**: 生产环境必须

## 部署架构

```
互联网 → Nginx (反向代理) → Nuxt应用 → MySQL数据库
         |
         ├─ SSL终止
         ├─ 负载均衡
         ├─ 静态文件服务
         └─ 日志记录
```

## 部署步骤

### 1. 服务器初始化

```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装基础工具
sudo apt install -y curl wget git htop vim ufw

# 配置防火墙
sudo ufw allow 22    # SSH
sudo ufw allow 80    # HTTP
sudo ufw allow 443   # HTTPS
sudo ufw allow 3306  # MySQL (仅内网)
sudo ufw enable

# 创建应用用户
sudo useradd -m -s /bin/bash appuser
sudo usermod -aG sudo appuser
```

### 2. 安装Node.js

```bash
# 使用NodeSource仓库安装最新LTS版本
curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
sudo apt-get install -y nodejs

# 验证安装
node --version  # 应该显示 v18.x.x 或更高
npm --version

# 安装PM2进程管理器
sudo npm install -g pm2
```

### 3. 安装和配置MySQL

```bash
# 安装MySQL 8.0
sudo apt install -y mysql-server

# 安全配置
sudo mysql_secure_installation

# 登录MySQL
sudo mysql -u root -p
```

```sql
-- 创建应用数据库和用户
CREATE DATABASE activation_code_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建专用用户
CREATE USER 'activation_app'@'localhost' IDENTIFIED BY 'your_strong_password_here';

-- 授权
GRANT SELECT, INSERT, UPDATE, DELETE ON activation_code_system.* TO 'activation_app'@'localhost';
GRANT EXECUTE ON activation_code_system.* TO 'activation_app'@'localhost';
GRANT CREATE TEMPORARY TABLES ON activation_code_system.* TO 'activation_app'@'localhost';

-- 刷新权限
FLUSH PRIVILEGES;

-- 启用事件调度器
SET GLOBAL event_scheduler = ON;

-- 设置开机自启
-- 编辑 /etc/mysql/mysql.conf.d/mysqld.cnf
-- 添加: event_scheduler = ON
```

### 4. 配置MySQL性能优化

```bash
# 编辑MySQL配置文件
sudo vim /etc/mysql/mysql.conf.d/mysqld.cnf
```

```ini
[mysqld]
# 基本配置
bind-address = 127.0.0.1
port = 3306

# 性能优化
innodb_buffer_pool_size = 2G
innodb_log_file_size = 256M
max_connections = 200
query_cache_size = 128M
query_cache_type = 1

# 字符集
character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci

# 事件调度器
event_scheduler = ON

# 日志配置
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2
```

### 5. 部署应用代码

```bash
# 切换到应用用户
sudo su - appuser

# 克隆代码仓库
git clone https://github.com/your-repo/activation-code-system.git
cd activation-code-system

# 安装依赖（包括开发依赖，用于构建）
npm install

# 复制环境配置文件
cp .env.example .env
```

### 6. 配置环境变量

```bash
# 编辑环境配置
vim .env
```

```bash
# .env 文件内容
NODE_ENV=production
PORT=3000

# 数据库配置
DB_HOST=localhost
DB_PORT=3306
DB_NAME=activation_code_system
DB_USER=activation_app
DB_PASSWORD=your_strong_password_here

# JWT配置
JWT_SECRET=your_very_long_and_secure_jwt_secret_key_here

# 应用配置
APP_NAME=激活码验证系统
APP_URL=https://your-domain.com
APP_DEBUG=false

# 日志配置
LOG_LEVEL=error
LOG_PATH=/var/log/activation-code-system

# 缓存配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=

# 邮件配置（如需要）
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=your_email@example.com
SMTP_PASS=your_email_password
```

### 7. 初始化数据库

```bash
# 导入数据库结构
mysql -u activation_app -p activation_code_system < database/create_database.sql

# 导入存储过程
mysql -u activation_app -p activation_code_system < database/simple_expired_update.sql
mysql -u activation_app -p activation_code_system < database/helper_procedures.sql

# 验证表结构
mysql -u activation_app -p -e "USE activation_code_system; SHOW TABLES;"
```

### 8. 构建应用

```bash
# 构建生产版本（这一步是必须的！）
npm run build

# 验证构建结果
ls -la .output/

# 构建完成后，可以删除开发依赖以节省空间
npm prune --production

# .output目录包含了编译后的应用文件：
# .output/server/index.mjs - 服务端入口文件
# .output/public/ - 静态资源文件
# .output/nitro.json - 构建配置信息
```

**重要说明**：
- Nuxt 3应用**必须**经过构建才能在生产环境运行
- 源代码（pages/, components/, server/api/等）不能直接运行
- 构建后的`.output`目录包含优化后的生产代码
- 构建过程会进行代码压缩、tree-shaking、类型检查等优化

### 9. 配置PM2

```bash
# 创建PM2配置文件
vim ecosystem.config.js
```

```javascript
module.exports = {
  apps: [{
    name: 'activation-code-system',
    port: 3000,
    exec_mode: 'cluster',
    instances: 'max', // 或指定数量，如 2
    script: './.output/server/index.mjs',  // 关键：指向构建后的文件，不是源码
    env: {
      NODE_ENV: 'production',
      NITRO_PORT: 3000,  // Nuxt 3使用NITRO_PORT而不是PORT
      NITRO_HOST: '127.0.0.1'
    },
    error_file: '/var/log/activation-code-system/error.log',
    out_file: '/var/log/activation-code-system/out.log',
    log_file: '/var/log/activation-code-system/combined.log',
    time: true,
    max_memory_restart: '1G',
    min_uptime: '10s',
    max_restarts: 5,
    autorestart: true,
    watch: false,  // 生产环境关闭文件监听
    node_args: '--max-old-space-size=2048'
  }]
}
```

**重要说明**：
- `script`必须指向`./.output/server/index.mjs`，这是构建后的入口文件
- 不能指向源码文件如`server/index.js`或`app.vue`等
- 使用`NITRO_PORT`和`NITRO_HOST`环境变量（Nuxt 3特有）
- 生产环境关闭`watch`功能以提高性能

### 10. 安装和配置Nginx

```bash
# 安装Nginx
sudo apt install -y nginx

# 创建虚拟主机配置
sudo vim /etc/nginx/sites-available/activation-code-system
```

```nginx
# Nginx配置文件
server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    
    # 重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;
    
    # SSL配置
    ssl_certificate /etc/letsencrypt/live/your-domain.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/your-domain.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;
    
    # 安全头
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    
    # 日志
    access_log /var/log/nginx/activation-code-system.access.log;
    error_log /var/log/nginx/activation-code-system.error.log;
    
    # 反向代理到Nuxt应用
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }
    
    # 静态文件缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://127.0.0.1:3000;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    # API限流
    location /api/ {
        limit_req zone=api_limit burst=20 nodelay;
        proxy_pass http://127.0.0.1:3000;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

# 全局配置添加限流
http {
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
}
```

### 11. 获取SSL证书

```bash
# 安装Certbot
sudo apt install -y certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d your-domain.com -d www.your-domain.com

# 设置自动续期
sudo crontab -e
# 添加: 0 12 * * * /usr/bin/certbot renew --quiet
```

### 12. 启动服务

```bash
# 启用Nginx站点
sudo ln -s /etc/nginx/sites-available/activation-code-system /etc/nginx/sites-enabled/
sudo nginx -t  # 测试配置
sudo systemctl reload nginx

# 创建日志目录
sudo mkdir -p /var/log/activation-code-system
sudo chown appuser:appuser /var/log/activation-code-system

# 启动应用
pm2 start ecosystem.config.js

# 保存PM2配置
pm2 save
pm2 startup

# 设置开机自启
sudo systemctl enable nginx
sudo systemctl enable mysql
```

## 部署验证

### 1. 功能测试

```bash
# 测试API端点
curl -X POST https://your-domain.com/api/codes/validate \
  -H "Content-Type: application/json" \
  -d '{
    "code": "TEST1234567890123456789012345678",
    "userId": 1,
    "deviceFingerprint": "test-device",
    "ip": "127.0.0.1"
  }'

# 测试SSL
curl -I https://your-domain.com

# 测试重定向
curl -I http://your-domain.com
```

### 2. 性能测试

```bash
# 安装测试工具
sudo apt install -y apache2-utils

# 并发测试
ab -n 1000 -c 10 https://your-domain.com/

# 内存使用监控
pm2 monit
```

## 监控和维护

### 1. 日志管理

```bash
# 设置日志轮转
sudo vim /etc/logrotate.d/activation-code-system
```

```
/var/log/activation-code-system/*.log {
    daily
    missingok
    rotate 52
    compress
    delaycompress
    notifempty
    create 0644 appuser appuser
    postrotate
        pm2 reload activation-code-system
    endscript
}
```

### 2. 监控脚本

```bash
# 创建健康检查脚本
vim /home/appuser/health-check.sh
```

```bash
#!/bin/bash
# 健康检查脚本

LOG_FILE="/var/log/activation-code-system/health-check.log"
API_URL="https://your-domain.com/api/codes/validate"

# 检查应用是否运行
if ! pm2 list | grep -q "activation-code-system.*online"; then
    echo "$(date): Application is down, restarting..." >> $LOG_FILE
    pm2 restart activation-code-system
fi

# 检查数据库连接
if ! mysqladmin ping -h localhost -u activation_app -p"$DB_PASSWORD" >/dev/null 2>&1; then
    echo "$(date): Database connection failed" >> $LOG_FILE
fi

# 检查磁盘空间
DISK_USAGE=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
if [ $DISK_USAGE -gt 80 ]; then
    echo "$(date): Disk usage is ${DISK_USAGE}%" >> $LOG_FILE
fi
```

```bash
# 设置定时任务
chmod +x /home/appuser/health-check.sh
crontab -e
# 添加: */5 * * * * /home/appuser/health-check.sh
```

### 3. 备份策略

```bash
# 创建备份脚本
vim /home/appuser/backup.sh
```

```bash
#!/bin/bash
# 数据库备份脚本

BACKUP_DIR="/home/appuser/backups"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="activation_code_system"
DB_USER="activation_app"
DB_PASS="your_password"

mkdir -p $BACKUP_DIR

# 数据库备份
mysqldump -u $DB_USER -p$DB_PASS $DB_NAME > $BACKUP_DIR/db_backup_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/db_backup_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "db_backup_*.sql.gz" -mtime +7 -delete

echo "$(date): Backup completed - db_backup_$DATE.sql.gz"
```

```bash
# 设置每日备份
chmod +x /home/appuser/backup.sh
crontab -e
# 添加: 0 2 * * * /home/appuser/backup.sh
```

## 安全加固

### 1. 系统安全

```bash
# 安装fail2ban
sudo apt install -y fail2ban

# 配置fail2ban
sudo vim /etc/fail2ban/jail.local
```

```ini
[DEFAULT]
bantime = 3600
findtime = 600
maxretry = 5

[sshd]
enabled = true

[nginx-http-auth]
enabled = true

[nginx-limit-req]
enabled = true
filter = nginx-limit-req
action = iptables-multiport[name=ReqLimit, port="http,https", protocol=tcp]
logpath = /var/log/nginx/*error.log
findtime = 600
bantime = 7200
maxretry = 10
```

### 2. 应用安全

```bash
# 创建安全配置文件
vim /home/appuser/activation-code-system/security.js
```

```javascript
// 安全中间件配置
export default {
  // 请求限流
  rateLimit: {
    max: 100, // 每分钟最大请求数
    windowMs: 60 * 1000, // 时间窗口
    message: '请求过于频繁，请稍后再试'
  },
  
  // CORS配置
  cors: {
    origin: ['https://your-domain.com'],
    credentials: true
  },
  
  // 安全头
  helmet: {
    contentSecurityPolicy: {
      directives: {
        defaultSrc: ["'self'"],
        styleSrc: ["'self'", "'unsafe-inline'"],
        scriptSrc: ["'self'"],
        imgSrc: ["'self'", "data:", "https:"]
      }
    }
  }
}
```

## 性能优化

### 1. 数据库优化

```sql
-- 创建性能监控视图
CREATE VIEW performance_stats AS
SELECT 
    SCHEMA_NAME as database_name,
    ROUND(SUM(data_length + index_length) / 1024 / 1024, 2) AS 'DB Size in MB'
FROM information_schema.tables 
WHERE table_schema = 'activation_code_system'
GROUP BY table_schema;

-- 添加索引优化
ALTER TABLE activation_code ADD INDEX idx_status_expiration (status, expirationDate);
ALTER TABLE activation_record ADD INDEX idx_activation_time (activationTime);
```

### 2. 缓存策略

```bash
# 安装Redis（可选）
sudo apt install -y redis-server

# 配置Redis
sudo vim /etc/redis/redis.conf
# 设置: maxmemory 256mb
# 设置: maxmemory-policy allkeys-lru
```

## 运维命令

### 常用管理命令

```bash
# 应用管理
pm2 list                    # 查看应用状态
pm2 restart activation-code-system  # 重启应用
pm2 logs activation-code-system     # 查看日志
pm2 monit                   # 实时监控

# 服务管理
sudo systemctl status nginx
sudo systemctl restart nginx
sudo systemctl status mysql

# 性能监控
htop                        # 系统资源监控
df -h                       # 磁盘使用情况
free -m                     # 内存使用情况
netstat -tulpn              # 端口监听状态

# 日志查看
tail -f /var/log/activation-code-system/combined.log
tail -f /var/log/nginx/activation-code-system.access.log
tail -f /var/log/mysql/error.log
```

### 故障排查

```bash
# 检查应用状态
curl -I https://your-domain.com/
pm2 describe activation-code-system

# 检查数据库
mysql -u activation_app -p -e "SELECT 1"

# 检查配置
nginx -t
pm2 prettylist

# 查看错误日志
grep ERROR /var/log/activation-code-system/error.log
grep error /var/log/nginx/activation-code-system.error.log
```

## 更新部署

### 应用更新流程

```bash
# 1. 备份当前版本
cp -r /home/appuser/activation-code-system /home/appuser/activation-code-system.backup

# 2. 拉取最新代码
cd /home/appuser/activation-code-system
git pull origin main

# 3. 更新依赖
npm install

# 4. 构建新版本
npm run build

# 5. 无停机更新
pm2 reload activation-code-system

# 6. 验证更新
curl -I https://your-domain.com/
```

### 回滚策略

```bash
# 如果更新有问题，快速回滚
pm2 stop activation-code-system
rm -rf /home/appuser/activation-code-system
mv /home/appuser/activation-code-system.backup /home/appuser/activation-code-system
cd /home/appuser/activation-code-system
pm2 start ecosystem.config.js
```

## 总结

通过以上步骤，您可以成功将激活码验证系统部署到生产服务器。关键要点：

1. **安全性优先**：使用HTTPS、防火墙、用户权限控制
2. **性能优化**：数据库索引、Nginx缓存、PM2集群模式
3. **监控告警**：日志管理、健康检查、性能监控
4. **备份恢复**：定期备份、快速回滚机制
5. **运维自动化**：脚本化部署、定时任务、自动重启

建议在部署前先在测试环境完整验证所有流程。
