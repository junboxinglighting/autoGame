# 激活码验证接口文档

## 接口概述

激活码验证接口用于验证和激活用户的激活码，支持IP地址绑定和验证功能，确保激活码的安全使用。

## 接口详情

### 基本信息

- **接口地址**: `POST /api/codes/validate`
- **请求方式**: POST
- **Content-Type**: `application/json`
- **认证要求**: 无需认证（公开接口）

### 功能特性

1. **首次激活**: 未使用的激活码会被激活，并将IP地址、设备指纹绑定到该激活码
2. **重复验证**: 已激活的激活码会验证IP地址是否匹配
3. **IP保护**: 如果IP地址不匹配，返回专用状态码3
4. **状态检查**: 检查激活码是否过期、被吊销等
5. **黑名单检查**: 检查激活码、设备指纹、IP是否在黑名单中
6. **设备绑定**: 支持设备指纹绑定验证

## 请求参数

### 请求体参数

| 参数名 | 类型 | 必填 | 描述 | 示例 |
|--------|------|------|------|------|
| code | string | 是 | 激活码，32位字母数字组合 | "BEW6EDQCYDRBZNBQ4DJIJGTQYGA4993A" |
| userId | number | 是 | 用户ID，用于日志记录和令牌生成 | 1001 |
| deviceFingerprint | string | 是 | 设备指纹，用于设备绑定验证 | "device-001" |
| ip | string | 是 | 用户IP地址，用于IP绑定和验证 | "192.168.1.100" |

### 请求示例

```json
{
  "code": "BEW6EDQCYDRBZNBQ4DJIJGTQYGA4993A",
  "userId": 1001,
  "deviceFingerprint": "device-fingerprint-12345",
  "ip": "192.168.1.100"
}
```

```javascript
// JavaScript 请求示例
const response = await fetch('/api/codes/validate', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    code: 'BEW6EDQCYDRBZNBQ4DJIJGTQYGA4993A',
    userId: 1001,
    deviceFingerprint: 'device-fingerprint-12345',
    ip: '192.168.1.100'
  })
});

const result = await response.json();
console.log(result);
```

```bash
# cURL 请求示例
curl -X POST http://localhost:3001/api/codes/validate \
  -H "Content-Type: application/json" \
  -d '{
    "code": "BEW6EDQCYDRBZNBQ4DJIJGTQYGA4993A",
    "userId": 1001,
    "deviceFingerprint": "device-fingerprint-12345",
    "ip": "192.168.1.100"
  }'
```

## 响应格式

### 响应字段说明

| 字段名 | 类型 | 描述 |
|--------|------|------|
| success | boolean | 请求是否成功处理 |
| code | number | HTTP状态码 |
| message | string | 响应消息 |
| data | object | 响应数据对象 |
| data.valid | boolean | 激活码是否有效 |
| data.statusCode | number | 业务状态码（详见下文） |
| data.message | string | 详细状态描述 |
| data.token | string | 授权令牌（仅成功时返回） |
| data.expiryTime | string | 过期时间（仅成功时返回） |

### 状态码说明

| 状态码 | 含义 | 描述 |
|--------|------|------|
| 1 | 验证成功 | 激活成功或IP地址匹配验证成功 |
| 2 | 验证失败 | 激活码无效、过期、被吊销或其他一般性错误 |
| 3 | IP冲突 | 激活码已被其他IP地址使用，无法在当前IP使用 |

## 响应示例

### 场景1：首次激活成功

**请求条件**: 激活码状态为"未使用"

```json
{
  "success": true,
  "code": 1,
  "message": "验证成功",
  "data": {
    "valid": true,
    "statusCode": 1,
    "message": "激活成功",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjb2RlIjoiQkVXNkVEUUNZRFJCWk5CUTRESkl...",
    "expiryTime": "2026-08-02T15:30:00.000Z"
  }
}
```

### 场景2：IP匹配验证成功

**请求条件**: 激活码已激活且IP地址匹配

```json
{
  "success": true,
  "code": 1,
  "message": "验证成功",
  "data": {
    "valid": true,
    "statusCode": 1,
    "message": "验证成功",
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJjb2RlIjoiQkVXNkVEUUNZRFJCWk5CUTRESkl...",
    "expiryTime": "2026-08-02T15:30:00.000Z"
  }
}
```

### 场景3：IP地址冲突

**请求条件**: 激活码已激活但IP地址不匹配

```json
{
  "success": false,
  "code": 3,
  "message": "验证失败",
  "data": {
    "valid": false,
    "statusCode": 3,
    "message": "该激活码已被其他IP使用"
  }
}
```

### 场景4：激活码不存在

```json
{
  "success": false,
  "code": 2,
  "message": "验证失败",
  "data": {
    "valid": false,
    "statusCode": 2,
    "message": "激活码不存在"
  }
}
```

### 场景5：激活码已过期

```json
{
  "success": false,
  "code": 2,
  "message": "验证失败",
  "data": {
    "valid": false,
    "statusCode": 2,
    "message": "激活码已过期"
  }
}
```

### 场景6：激活码已被吊销

```json
{
  "success": false,
  "code": 2,
  "message": "验证失败",
  "data": {
    "valid": false,
    "statusCode": 2,
    "message": "激活码已被吊销"
  }
}
```

### 场景7：设备不匹配

```json
{
  "success": false,
  "code": 2,
  "message": "验证失败",
  "data": {
    "valid": false,
    "statusCode": 2,
    "message": "激活码已绑定其他设备"
  }
}
```

### 场景8：黑名单拦截

```json
{
  "success": false,
  "code": 2,
  "message": "验证失败",
  "data": {
    "valid": false,
    "statusCode": 2,
    "message": "IP地址已被列入黑名单"
  }
}
```

## 错误响应

### HTTP 400 - 请求参数错误

```json
{
  "error": true,
  "statusCode": 400,
  "statusMessage": "激活码格式无效",
  "message": "激活码格式无效"
}
```

### HTTP 405 - 方法不允许

```json
{
  "error": true,
  "statusCode": 405,
  "statusMessage": "方法不允许",
  "message": "方法不允许"
}
```

### HTTP 500 - 服务器内部错误

```json
{
  "error": true,
  "statusCode": 500,
  "statusMessage": "服务器内部错误",
  "message": "服务器内部错误"
}
```

## 业务流程

### 验证流程图

```
开始
  ↓
检查请求方法是否为POST
  ↓
验证请求参数完整性
  ↓
检查激活码格式
  ↓
检查黑名单
  ↓
查询激活码信息
  ↓
激活码状态判断
  ├── 未使用 → 检查过期时间 → 检查设备绑定 → 激活成功
  ├── 已激活 → 验证IP地址 → 
  │                ├── IP匹配 → 返回现有Token
  │                └── IP不匹配 → 返回状态码3
  ├── 已过期 → 返回过期错误
  └── 已吊销 → 返回吊销错误
```

### 详细验证步骤

1. **请求预处理**
   - 验证HTTP方法为POST
   - 解析JSON请求体
   - 验证必填参数

2. **参数格式验证**
   - 激活码格式验证（32位字母数字）
   - 用户ID非空验证
   - 设备指纹非空验证
   - IP地址非空验证

3. **安全检查**
   - 黑名单检查（激活码、设备指纹、IP）
   - 记录失败尝试

4. **激活码查询**
   - 从数据库查询激活码信息
   - 检查激活码是否存在

5. **状态验证**
   - **已激活状态**: 验证IP地址匹配性
   - **未使用状态**: 进行激活流程
   - **其他状态**: 返回相应错误

6. **激活流程**（仅未使用状态）
   - 检查过期时间
   - 检查设备绑定
   - 更新激活码状态
   - 生成授权令牌
   - 记录激活成功

## 数据库操作

### 涉及的数据表

1. **activation_code** - 激活码主表
2. **activation_record** - 激活记录表
3. **authorization_info** - 授权信息表
4. **blacklist** - 黑名单表

### 关键SQL操作

```sql
-- 查询激活码信息
SELECT * FROM activation_code WHERE activationCode = ?

-- 更新激活码状态
UPDATE activation_code 
SET status = ?, deviceFingerprint = ?, ip = ?, 
    activationDate = NOW(), lastModifiedTime = NOW() 
WHERE activationCode = ?

-- 记录激活成功
INSERT INTO activation_record 
(activationCode, deviceFingerprint, ip, activationTime, result) 
VALUES (?, ?, ?, NOW(), ?)

-- 保存授权信息
INSERT INTO authorization_info 
(activationCode, tokenContent, effectiveTime, expiryTime, createdTime) 
VALUES (?, ?, NOW(), ?, NOW())
```

## 集成指南

### 前端集成

```javascript
class ActivationService {
  async validateCode(code, userId, deviceFingerprint, ip) {
    try {
      const response = await fetch('/api/codes/validate', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          code,
          userId,
          deviceFingerprint,
          ip
        })
      });
      
      const result = await response.json();
      
      switch (result.data?.statusCode) {
        case 1:
          // 验证成功，保存token
          localStorage.setItem('authToken', result.data.token);
          return { success: true, token: result.data.token };
          
        case 2:
          // 一般失败
          return { success: false, message: result.data.message };
          
        case 3:
          // IP冲突
          return { 
            success: false, 
            message: '此激活码已在其他地址使用',
            isIpConflict: true 
          };
          
        default:
          return { success: false, message: '未知错误' };
      }
    } catch (error) {
      console.error('验证请求失败:', error);
      return { success: false, message: '网络错误' };
    }
  }
}
```

### 移动端集成

```swift
// iOS Swift 示例
struct ActivationRequest: Codable {
    let code: String
    let userId: Int
    let deviceFingerprint: String
    let ip: String
}

struct ActivationResponse: Codable {
    let success: Bool
    let code: Int
    let message: String
    let data: ActivationData?
}

struct ActivationData: Codable {
    let valid: Bool
    let statusCode: Int
    let message: String
    let token: String?
    let expiryTime: String?
}

func validateActivationCode(
    code: String,
    userId: Int,
    deviceFingerprint: String,
    ip: String
) async throws -> ActivationResponse {
    let request = ActivationRequest(
        code: code,
        userId: userId,
        deviceFingerprint: deviceFingerprint,
        ip: ip
    )
    
    let url = URL(string: "https://api.example.com/api/codes/validate")!
    var urlRequest = URLRequest(url: url)
    urlRequest.httpMethod = "POST"
    urlRequest.setValue("application/json", forHTTPHeaderField: "Content-Type")
    urlRequest.httpBody = try JSONEncoder().encode(request)
    
    let (data, _) = try await URLSession.shared.data(for: urlRequest)
    return try JSONDecoder().decode(ActivationResponse.self, from: data)
}
```

## 安全考虑

### 1. IP绑定安全
- IP地址一旦绑定无法更改
- 支持检测IP变化情况
- 防止激活码在多个地址使用

### 2. 设备绑定
- 设备指纹用于防止跨设备使用
- 支持设备指纹验证

### 3. 黑名单机制
- 支持激活码黑名单
- 支持IP地址黑名单
- 支持设备指纹黑名单

### 4. 日志记录
- 记录所有验证尝试
- 记录失败原因
- 支持审计追踪

## 性能优化

### 1. 数据库优化
- 激活码字段建立索引
- 使用连接池
- 避免长事务

### 2. 缓存策略
- 可考虑对激活码状态进行缓存
- 黑名单数据缓存

### 3. 并发处理
- 支持高并发验证请求
- 避免激活码重复激活

## 监控和告警

### 关键指标
- 激活成功率
- IP冲突频率
- 黑名单拦截次数
- 响应时间

### 告警规则
- 激活失败率过高
- IP冲突频繁
- 数据库连接异常
- 接口响应超时

## 常见问题

### Q: 如何处理IP地址变化？
A: 目前IP地址一旦绑定无法自动更新。如需更换IP，需要管理员手动处理或重新生成激活码。

### Q: 设备指纹如何生成？
A: 设备指纹应由客户端生成，建议包含设备型号、操作系统版本、网络信息等唯一标识。

### Q: Token过期后如何处理？
A: Token过期后需要重新调用验证接口，系统会返回新的Token。

### Q: 激活码格式有什么要求？
A: 激活码必须是32位字母数字组合，不区分大小写。

### Q: 如何批量验证激活码？
A: 目前只支持单个激活码验证，批量操作需要多次调用接口。

## 更新历史

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| 1.0.0 | 2025-08-02 | 初始版本，支持基本激活码验证 |
| 1.1.0 | 2025-08-02 | 新增IP地址绑定和验证功能 |
| 1.1.1 | 2025-08-02 | 完善状态码系统，新增状态码3 |
| 1.2.0 | 2025-08-06 | 新增部署指南和生产环境配置说明 |

## 部署说明

### 生产环境部署
- **详细部署指南**: 请参考 `docs/部署指南.md`
- **推荐配置**: Ubuntu 22.04 + Node.js 18+ + MySQL 8.0+ + Nginx + PM2
- **安全要求**: HTTPS必须，防火墙配置，数据库用户权限最小化

### 环境要求
- **服务器**: 最低4GB内存，推荐8GB+
- **数据库**: MySQL 8.0+，启用事件调度器
- **反向代理**: Nginx，配置SSL和安全头
- **进程管理**: PM2集群模式

### 监控建议
- 应用状态监控（PM2）
- 数据库性能监控
- 系统资源监控（CPU、内存、磁盘）
- API响应时间和成功率监控

---

**联系方式**: 如有问题请联系开发团队
**文档更新**: 2025年8月6日
